# Firebase Backend Specification - CoodYou

## Overview
Complete Firebase backend implementation for CoodYou food delivery platform supporting iOS native app, web admin interface, and comprehensive delivery request system.

**Project**: `coodyou-hag`  
**Status**: ‚úÖ DEPLOYED  
**Last Updated**: September 28, 2025

## üöÄ Deployed Components

### Cloud Functions (12 callables + 2 triggers)
All functions deployed to `us-central1` with Node.js 18 runtime:

#### Core Order Management
- ‚úÖ `queueOrder` - Pairs orders, creates runs, updates pool snapshots
- ‚úÖ `cancelOrder` - Handles buyer cancellations
- ‚úÖ `claimRun` - Dasher claims delivery run
- ‚úÖ `markPickedUp` - Dasher marks order picked up
- ‚úÖ `markDelivered` - Dasher marks order delivered with PIN verification

#### Delivery Request System
- ‚úÖ `createDeliveryRequest` - Creates delivery request from order
- ‚úÖ `respondToDeliveryRequest` - Dasher accepts/declines requests
- ‚úÖ `completeDeliveryRequest` - Completes delivery with PIN verification

#### User Management
- ‚úÖ `updateDasherAvailability` - Toggle dasher online/offline status
- ‚úÖ `requestSetSchool` - Admin function to set user school
- ‚úÖ `requestStripeOnboarding` - Stripe integration placeholder

#### Background Jobs
- ‚úÖ `cleanupExpiredRequests` - Expires old delivery requests (every 5 min)
- ‚úÖ `recalculatePricing` - Updates pricing config (daily)

#### Auth Triggers
- ‚úÖ `onUserCreate` - Auto-creates user profile on signup

### Firestore Database Schema

#### Core Collections
```
users/{uid}
‚îú‚îÄ‚îÄ id: string
‚îú‚îÄ‚îÄ firstName: string
‚îú‚îÄ‚îÄ lastName: string
‚îú‚îÄ‚îÄ email: string
‚îú‚îÄ‚îÄ phoneNumber?: string
‚îú‚îÄ‚îÄ rolePreferences: string[] // ["buyer", "dasher"]
‚îú‚îÄ‚îÄ canDash: boolean
‚îú‚îÄ‚îÄ eligibleSchoolIds: string[]
‚îú‚îÄ‚îÄ rating: number
‚îú‚îÄ‚îÄ completedRuns: number
‚îú‚îÄ‚îÄ stripeConnected: boolean
‚îú‚îÄ‚îÄ pushToken?: string
‚îú‚îÄ‚îÄ schoolId?: string
‚îú‚îÄ‚îÄ defaultPaymentMethodId?: string
‚îú‚îÄ‚îÄ paymentProviderPreferences: string[]
‚îú‚îÄ‚îÄ settings: object
‚îî‚îÄ‚îÄ createdAt: timestamp

schools/{schoolId}
‚îú‚îÄ‚îÄ name: string
‚îú‚îÄ‚îÄ allowedEmailDomains: string[]
‚îî‚îÄ‚îÄ metadata...

diningHalls/{hallId}
‚îú‚îÄ‚îÄ name: string
‚îú‚îÄ‚îÄ location: geopoint
‚îú‚îÄ‚îÄ hours: object
‚îî‚îÄ‚îÄ metadata...

orders/{orderId}
‚îú‚îÄ‚îÄ id: string
‚îú‚îÄ‚îÄ userId: string (buyer)
‚îú‚îÄ‚îÄ dasherId?: string
‚îú‚îÄ‚îÄ hallId: string
‚îú‚îÄ‚îÄ windowType: "breakfast" | "lunch" | "dinner"
‚îú‚îÄ‚îÄ status: OrderStatus
‚îú‚îÄ‚îÄ priceCents: number
‚îú‚îÄ‚îÄ lineItems: OrderLineItem[]
‚îú‚îÄ‚îÄ specialInstructions?: string
‚îú‚îÄ‚îÄ meetPoint?: { lat: number, lng: number, description: string }
‚îú‚îÄ‚îÄ pinCode?: string
‚îú‚îÄ‚îÄ deliveryRequestId?: string
‚îú‚îÄ‚îÄ pairGroupId?: string
‚îú‚îÄ‚îÄ isSoloFallback?: boolean
‚îú‚îÄ‚îÄ createdAt: timestamp
‚îî‚îÄ‚îÄ updatedAt: timestamp

runs/{runId}
‚îú‚îÄ‚îÄ id: string
‚îú‚îÄ‚îÄ hallId: string
‚îú‚îÄ‚îÄ dasherId?: string
‚îú‚îÄ‚îÄ status: OrderStatus
‚îú‚îÄ‚îÄ pairGroupId: string
‚îú‚îÄ‚îÄ estimatedPayoutCents: number
‚îú‚îÄ‚îÄ deliveryPin: string
‚îú‚îÄ‚îÄ createdAt: timestamp
‚îî‚îÄ‚îÄ orders/{orderId} // subcollection with order snapshots

deliveryRequests/{requestId}
‚îú‚îÄ‚îÄ id: string
‚îú‚îÄ‚îÄ orderId: string
‚îú‚îÄ‚îÄ buyerId: string
‚îú‚îÄ‚îÄ hallId: string
‚îú‚îÄ‚îÄ windowType: string
‚îú‚îÄ‚îÄ status: "open" | "assigned" | "completed" | "expired"
‚îú‚îÄ‚îÄ requestedAt: timestamp
‚îú‚îÄ‚îÄ expiresAt: timestamp
‚îú‚îÄ‚îÄ items: string[]
‚îú‚îÄ‚îÄ instructions?: string
‚îú‚îÄ‚îÄ meetPoint: { latitude: number, longitude: number, description: string }
‚îú‚îÄ‚îÄ assignedDasherId?: string
‚îú‚îÄ‚îÄ candidateDasherIds: string[]
‚îú‚îÄ‚îÄ createdBy: string
‚îî‚îÄ‚îÄ updatedAt: timestamp

dasherAvailability/{dasherId}
‚îú‚îÄ‚îÄ id: string
‚îú‚îÄ‚îÄ isOnline: boolean
‚îî‚îÄ‚îÄ updatedAt: timestamp

pair_groups/{groupId}
‚îú‚îÄ‚îÄ hallId: string
‚îú‚îÄ‚îÄ windowType: string
‚îú‚îÄ‚îÄ targetSize: number
‚îú‚îÄ‚îÄ filledCount: number
‚îú‚îÄ‚îÄ status: "open" | "filled"
‚îú‚îÄ‚îÄ pin: string
‚îî‚îÄ‚îÄ createdAt: timestamp

hallPools/{hallId_windowType}
‚îú‚îÄ‚îÄ hallId: string
‚îú‚îÄ‚îÄ windowType: string
‚îú‚îÄ‚îÄ queueSize: number
‚îú‚îÄ‚îÄ averageWaitSeconds: number
‚îî‚îÄ‚îÄ updatedAt: timestamp

payments/{paymentId}
‚îú‚îÄ‚îÄ runId: string
‚îú‚îÄ‚îÄ dasherId: string
‚îú‚îÄ‚îÄ buyerIds: string[]
‚îú‚îÄ‚îÄ amountCents: number
‚îú‚îÄ‚îÄ feeCents: number
‚îú‚îÄ‚îÄ payoutCents: number
‚îú‚îÄ‚îÄ status: "captured"
‚îî‚îÄ‚îÄ createdAt: timestamp

paymentMethods/{pmId}
‚îú‚îÄ‚îÄ userId: string
‚îú‚îÄ‚îÄ type: string
‚îî‚îÄ‚îÄ metadata...
```

### Firestore Security Rules
‚úÖ Deployed comprehensive security rules:
- **Auth required** for all operations
- **User isolation** - users can only access own data
- **Role-based access** - dashers can access assigned runs/requests
- **Admin overrides** via custom claims
- **Protected fields** - server-only fields like `canDash`, `rating`
- **Validation helpers** for order creation and updates

### Firestore Indexes
‚úÖ Deployed optimized composite indexes for:
- **Delivery Requests**: `candidateDasherIds` (array-contains) + `status`
- **Delivery Requests**: `status` + `expiresAt` (for cleanup)
- **Orders**: Multiple composite indexes for user queries, hall+window filtering
- **Runs**: Dasher assignment and hall-based queries
- **Payments**: Dasher earnings history

## üì± Client Integration Contracts

### iOS App Integration
The iOS app (`CoodYou/`) integrates via:

#### Services
- `AuthService.swift` - handles auth flows and profile creation
- `DiningHallService.swift` - hall data and menus
- `OrderService.swift` - order creation and tracking  
- `MatchingService.swift` - delivery request matching
- `DeliveryRequestService.swift` - request lifecycle management
- `PaymentService.swift` - payment method management

#### Expected Flows
```swift
// Buyer Order Flow
1. OrderService.createOrder() -> writes order doc
2. OrderService.queueOrder() -> calls queueOrder function
3. DeliveryRequestService.createDeliveryRequest() -> calls createDeliveryRequest
4. Real-time listening on deliveryRequests for status updates

// Dasher Flow  
1. AuthService.toggleDasherAvailability() -> calls updateDasherAvailability
2. DeliveryRequestService.observeOpenRequests() -> listens to candidateDasherIds
3. DeliveryRequestService.respond() -> calls respondToDeliveryRequest
4. MatchingService.observeAssignments() -> tracks assigned runs
```

### Web Admin Integration
Web components (`CoodYouWeb/`) provide:
- **useAuth.tsx** - authentication hook with profile management
- **types.ts** - TypeScript definitions matching Firestore schema
- Admin dashboard components for monitoring and management

## üîê Authentication & Authorization

### Auth Providers
- ‚úÖ Email/Password
- ‚úÖ Phone (OTP via Firebase Auth)  
- ‚úÖ Google Sign-In
- ‚úÖ Apple Sign-In

### Authorization Levels
- **Buyer**: Create orders, view own data
- **Dasher**: Access delivery requests, manage runs, toggle availability
- **Admin**: Full access via custom claims (`admin: true`)

### Profile Creation
- Auto-triggered on signup via `onUserCreate`
- School verification via email domain matching
- Role preferences set based on school eligibility
- Custom claims for `canDash` capability

## üîÑ Real-time Features

### Live Updates
- **Order Status**: Real-time order status tracking
- **Delivery Requests**: Live request assignments and responses  
- **Dasher Availability**: Instant online/offline status
- **Hall Pools**: Live queue size and wait times
- **Run Assignments**: Real-time run claim notifications

### Push Notifications (Ready for Implementation)
- Infrastructure ready in user profiles (`pushToken` field)
- Delivery request notifications to candidate dashers
- Order status updates to buyers
- Run assignment confirmations

## ‚öôÔ∏è Operational Features

### Background Jobs
- **Request Cleanup**: Auto-expires delivery requests after 10 minutes
- **Pricing Updates**: Daily recalculation of hall-specific pricing
- **Pool Snapshots**: Real-time queue size calculations

### Data Management
- **Order Pairing**: Automatic order grouping by hall+window
- **PIN Verification**: Secure delivery confirmation system
- **Payment Tracking**: Complete payout calculation and recording
- **Error Handling**: Comprehensive validation and error responses

## üöÄ Deployment Status

### Environment
- **Firebase Project**: `coodyou-hag`
- **Runtime**: Node.js 18 (will need upgrade before Oct 2025)
- **Region**: `us-central1`  
- **Billing**: Blaze (pay-as-you-go) plan enabled

### Resource Usage
- **Functions**: 12 callables + 2 triggers deployed
- **Firestore**: Rules and indexes deployed successfully  
- **Build Size**: ~86.8 KB function package
- **Dependencies**: firebase-admin, firebase-functions, zod, stripe

## üìã Testing Checklist

### Function Testing
```bash
# Test delivery request flow locally
cd functions
firebase emulators:start --only functions,firestore
# Call functions via emulator UI at http://localhost:4000
```

### Integration Testing
- ‚úÖ Order creation and queuing
- ‚úÖ Dasher availability toggle
- ‚úÖ Delivery request assignment
- ‚úÖ PIN verification system
- ‚úÖ Payment calculation and recording

## üîß Maintenance & Upgrades

### Immediate Actions Needed
- [ ] Upgrade Node.js runtime to 20 or 22 (before Oct 30, 2025)
- [ ] Upgrade firebase-functions to v5+ for latest features
- [ ] Implement push notification sending in functions
- [ ] Add Stripe webhook handlers for payment verification

### Monitoring
- Function logs via Firebase Console
- Firestore usage and performance metrics
- Error rate monitoring for delivery request matching
- Queue time analytics via hallPools collection

## üìö Documentation

### API Reference
- All functions use Zod validation for request payloads
- Consistent error handling with Firebase HTTP error codes
- RESTful patterns for resource management
- Real-time subscriptions via Firestore listeners

### Data Flow Architecture
```
iOS App ‚Üí Firebase Auth ‚Üí Cloud Functions ‚Üí Firestore ‚Üí Real-time Updates ‚Üí iOS App
                                      ‚Üì
                               Push Notifications (FCM)
                                      ‚Üì  
                               External Services (Stripe)
```

This specification represents a production-ready Firebase backend supporting the complete CoodYou food delivery platform with real-time delivery request matching, secure payment processing, and comprehensive user management.